added_plasma_runs <- c("AbpTmAnr_h9DPL1skMvyje5U",
                       "AajqaHzI9_hCH4wYCbDAIYx4",
                       "ABE9wiNEoilBeYhlV1UO3VRC",
                       "AMw9wjlnV4lHRanHC8-jUnoh",
                       "ANei_Hsi__lGmaJ1k_Ji_d3O",
                       "AIH-1ryzAnFEMJ9R9-KI5_kA",
                       "AXP63fmerZZIn75npxDYZtYT",
                       "ADx0jDAXEJ9Ho7oP9cWlxCB-",
                       "AKr3CLJPqtxPgYm8EWbJ8z_4",
                       "AE5hBlinjEZN6ZZ1L7898Rzc",
                       "AXU04_NAKf5P3I1SrV_5x7oM",
                       "AAMd0bIaeDJOcqthTfVBekrg",
                       "AFzPNBUnw3NMOKplSiKRCqMU",
                       "ABeIKygVYa9ApLIqFBhxueub",
                       "ACi6KICyf0tNSK8b3m4op5O0",
                       "AHKsNmy-AFFNupR0Uot9fuks",
                       "AU-x-KCqRchJPaDwb-utcvvO",
                       "AR_CnOe8BaRPM71AHphnFT5J",
                       "AAMz3RV2Tv1MrI1oA5zynUyG",
                       "AHdh6Q0hlCRO263hSjLFJNQ7",
                       "Ado7dswg-kdHM5Fwb6dQYWOu",
                       "AKneBpDc1Q1Ln7Ev-5Iz53rK",
                       "AGwQDzxcqrdDlpzlcS10s1En",
                       "AU-GJVH_R-RAXa0UUil1MCik",
                       "AYO0H3fNbPBEOKwJA9dv9IH0",
                       "AMzRkv_uPpNMO6_XFokWfBuT",
                       "AVhAZ6wwwchE4IIQa6lOQhN4",
                       "ADNC-IlUdsROnLSz2AnnTpGz",
                       "AGU232uEYZZKe4oI95IrJu7o",
                       "AdA1JN9HI9ZND4LXP8XCfvRZ",
                       "AXVif6nxsixGLZDnsTvDtQLo",
                       "ALsopAc5KC1Bx7pJLiHZ-eJR",
                       "ASZMkYMxgytHgov13wWty29S",
                       "AVhoQhsYxHRPKbWD3ZTc9uCa",
                       "AEepGWqCaABI04g5DQESU97x",
                       "ABSYoqHZHR9Gvo_Z0scoIQ8w",
                       "AaRZMuj0NJtNnpZW8SO2dTy7",
                       "AJD93ZaVEQxGcbVGcJdZZW94",
                       "AdYl2rnCR1ZO5JLxgqP9fouS",
                       "AKorzNtokqVHNY5ZPcDPHeY3",
                       "AY-MEcYGsnlEp70J19fZmwOJ",
                       "AbZ6pmy7TndM4JOHXTcTCjde",
                       "AeUIQZkyte1MjIyV0h0MS0aI",
                       "AIjmFys4qs9EcrAcPI4IJxkK",
                       "AaJsBOVJsSFO2onZbHBDtn0C",
                       "AKY-0douAMNBU7L0NimzcmCS",
                       "ACHSPJ6rFXpCfKO7zOQZOWbz",
                       "AZjnWu5wiDlJapI4CxvEuFnk",
                       "AB2Pm9gToCJPGpSHjZEl7O5I",
                       "AB3ubPmTO1hKvpB3SpZ0JSCj",
                       "AceclBC2q4VHcKhBOYoHrQo9",
                       "AWdzkUCGn0JHYp3dMNlyPyI0",
                       "ASpCbtIIc89Mt4--IHz8OnPB",
                       "APzK4O25DCVD5YVyf63K1oGf",
                       "AW7bfwpDfPRK5ogAOE44LCq_",
                       "AGUZtNtuSiZEW4WOk9lYZtyN",
                       "AKDonBGXwm5CdrnHJERU_-c8",
                       "AT5xbQo2WQtI2oi_dtrom7dM",
                       "AFWAGp8DS6lNHrlt-I_azKUu",
                       "ANEzevwHG-lNYLnNIR6aTGu9",
                       "AIKiD4XtSL1NtbWtL5wIfq4m",
                       "AXWJJwFGdYJBjbqclsNsl3UA",
                       "ASP86HuqkG5G5KrN1nKqOGSh",
                       "AZL9sfd4ALRFeqYfyNABLq04",
                       "AQ53QFFOszBJZqx056aHcp4g",
                       "AKwjaEnnF1dAKKFcMt9igXXX",
                       "AEHqc78-RkhKwqARpiG9V9Qi",
                       "Aai5AQdklPpMlJfseoQaBysU",
                       "AauPU7MsWE1Dx51FLO3dJg33",
                       "ARBybyYWlGJHUbhbQPibrXGI",
                       "AEjxrRrIVjJGzbUFckTwpTpp",
                       "AGB9eRbQCw9Bj63KZctA4DQe",
                       "ARPd_ATt_oFBNrmQ7Yk_8YCo",
                       "AYPCtGCABftK1I8Ej2WnbTc3",
                       "ARYBp-g_dE9Gra-ukrIXW-zc",
                       "AKoN6VzAOI9HgKcaCj1z9S8v",
                       "AAOnQVP9mUBJk7Ij60bsjc6_",
                       "AEusTCGgvJ1NrKQysOxTwSBe",
                       "AKUURPIxRKxM5LcReW5cvFO9",
                       "AceCNHniaeJHxYPppCoBA3IC",
                       "AHdPMXCL5MNESr6hZ_jG_ZBb",
                       "AaT_Kpn0jHxPWpaPgfeRfhKv",
                       "AHuZCLmjisVM2rzDksjqeDeY",
                       "ATJcNmDM5ftEq6MGPd9T0jvI",
                       "AcG4B63MhUdIFKarxTRrlVJT",
                       "AL1jsnDnkt1JAaOcrR49GE75",
                       "AMYvDyuPMLlCkq3RB_iSljW2",
                       "AZR_EFZEsjxHLKcIz2BtCTIF",
                       "ABHWSzHFoC9FCIsgkICmgklO",
                       "Aa4vMChZHTdFe76BAPB2R8Pl",
                       "AUWXhCM3OB9PA6RKkSIqi--c",
                       "ASl7tgQWvuhA44Kx9otONfK0",
                       "ARkgLARFX_lCQL3jQm9qG7IA",
                       "AOiXc8th1tJMS6kdDAg812fA",
                       "AN4FOIx8IxRBb4TUapyllwUL",
                       "AKMNgjZH5H1Lp6YNlhyH6aBd",
                       "AKmgHQ2-w3RHTqVjtWTKLz60",
                       "AEdiX1AaYJBFM4G7307KEA2u",
                       "ACd87_ia0KFGu7P-NbfKjEjm",
                       "AceQabkgtrVDvohQ_gcEx7Yf",
                       "Aey6Fc2RkoZOzbYfanisg0qQ",
                       "AQtbNUZTuyhPsILE6IlVA4Pm",
                       "AAWEkxuGQU1JnbavepvVPBsD",
                       "AB3ZOj_GBFFLSreDu3jJRQ-f",
                       "ACtxh08dwsVML6duEQcNJTXy",
                       "AfTbk62xILhObZNIXnU-RF0S",
                       "AI124P7LxxtKAqQpBvLI4qbJ",
                       "APCWY7owjcdK1KzP8GiA8OTt",
                       "AXkQfNGk7UNJbIfH_lm-lkT1",
                       "ASlZOwsVEB5PKZhWnxPDRF1x",
                       "ASXIHv5LUiREo7vfg2s4aFot",
                       "AWKCkGCXNg1MILqFY32Zxhau",
                       "AYAXzWFtx_tAnIIBGtIRWskG",
                       "AQKsWv7Us6FFLYpbDuV1f0FM",
                       "AS-fkC55ubxKio0RjBCY_zJS",
                       "ASVK0QaHapZFLoEPpmbPaYzY",
                       "AQ2TJ4ZOJ9hCO6HN3MbPjgds",
                       "AWf7bLt7eY1BD7LluSreKG_3",
                       "AZJwzvTmz1VJy4ob52CyLqpi",
                       "AKBnV8jWM0NDX7CdztuRXoZf",
                       "AOekcpYezwRPE4YGIGb72q-U",
                       "APkBIk633oFCzpc3SxwowtXb",
                       "AVe6wy5HUulFn41rv3Rx371u",
                       "AYmaz9MQGCVHu7BdwTwBNpXe",
                       "AYUQsRurkNxKlZxM6mns82Dz",
                       "AILBSwGoCsVDFKBTEvsgEo7p",
                       "AFCUAOIZzN1Bz7_RdCyMb999",
                       "AfFlyWo37FtN16uRv8pFLCBp",
                       "AKOq_6jg8QBEtJ56mdDQRhCY",
                       "ALiWTGK4o89L_p-HAAVLa-g6",
                       "AQ7WUkiPdghLrbVZxFDZgvTx",
                       "AS9tve0kT4dHr6nyDAvSIeN2",
                       "AF_AzT3BtZNNAKdXMLlgL-kO",
                       "AFlB-kA2v09FcaDKD6YokkZ9",
                       "AIdbUPY2zoxL3IQqtbzznOr0",
                       "AIiyxr0Em7pNeoHgAzk5ExNN",
                       "AIJcFvMcwONPLZCB6thhkiPj",
                       "AN2HN25vi9JOLpbvICWovem4",
                       "AUoX7CUl_R9Km4NN5S6981gL",
                       "AZGYvMNad0NF_4sFhHvANYtT")
added_tissue_runs <- c("ALfftHDzDf9Evo2fz0r1muEC")

added_runs <- c(added_plasma_runs,
                added_tissue_runs)

library(AvenioUpdate)
`%ni%` <- Negate(`%in%`)
#### Test completeness of list####

# Test entries not present in the dataset
master_list <- readRDS("//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds")

analyses <- included_analyses(master_list)
if(any(analyses[[1]]$Analysis.ID %ni% added_runs)){
    analysis_oi <- analyses[[1]]$Analysis.ID[analyses[[1]]$Analysis.ID %ni% added_runs]
    print("These plasma or tissue run IDs are not included in this file:")
    analysis_oi
}else{
    print("All relevant run IDs are in this file")
}

# Test if all entries are unique
if(length(added_runs) != length(unique(added_runs))){
    print("These run IDs are not unique")
    poor_sample <- table(added_runs)[table(added_runs)!=1]
    poor_sample
}else{
    print("Run IDs are unique")
}

# Test if some entries not are 24 characters
if(any(nchar(added_runs) != 24)){
    poor_sample <- added_runs[nchar(added_runs) != 24]
    print("These run IDs are not 24 characters")
    poor_sample
}else{
    print("All run IDs are 24 characters")
}

#### Adding run ####

master_list <- readRDS("//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds")
dir <- "//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Plasma-AajqaHzI9_hCH4wYCbDAIYx4"
master_list <- add_run_to_list(master_list = master_list,
                               Directory = dir)
#### Recreating AVENIO_results_patients.rds ####

#If the "//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds"
#file should get corrupted or otherwise get lost/missing this script
#can recreate the file which has been updated as of 13-05-2025

#IMPORTANT! DO NOT RUN THIS UNLESS ABSOLUTELY NECESSARY!!!

library(readxl)
library(dplyr)
library(stringr)
`%ni%` <- Negate(`%in%`)

zip_path1 <- paste0("//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Plasma-",added_runs[1])

add_samples_mod <- function(Directory){
    Run_ID <- gsub("//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Plasma-","",Directory)
    zip_file <- paste0(Directory,"/","all_CSVs-",Run_ID,".zip")
    sample_file <- paste0(Directory,"/SampleMetrics.csv")
    run_ID_short <- substr(Run_ID,1,8)
    unzip(zipfile = zip_file,
          exdir = Directory)
    Filter_variants <- paste0(Directory,"/","VariantMetrics-UserFilterSet.csv")
    variants <- read.csv(Filter_variants)
    AVENIO_runs <- read_xlsx("//Synology_m1/Synology_folder/AVENIO/AVENIO_runs.xlsx",col_types = c(rep("guess",4),"date",rep("guess",6)))
    AVENIO_runs_select <- AVENIO_runs %>% 
        filter(grepl(run_ID_short,Run_ID))
    variants_select <- variants %>% 
        filter(Sample.ID %in% AVENIO_runs_select$Sample_name)
    samples_with_variants <- unique(variants_select$Sample.ID)
    samples_of_interest <- unique(AVENIO_runs_select$Sample_name)
    if(length(samples_with_variants) != length(samples_of_interest)){
        sample_metrics <- read.csv(sample_file) %>% 
            filter(Sample.ID %in% samples_of_interest) %>% 
            filter(Sample.ID %ni% samples_with_variants)
        sample_metrics <- sample_metrics %>% 
            select(colnames(sample_metrics)[colnames(sample_metrics) %in% colnames(variants_select)])
        sele_cols <- colnames(variants_select)[colnames(variants_select) %in% colnames(sample_metrics)]
        for(i in 1:length(sele_cols)){
            if(class(sample_metrics[[sele_cols[i]]]) != class(variants_select[[sele_cols[i]]])){
                classes <- c(class(sample_metrics[[sele_cols[i]]]),class(variants_select[[sele_cols[i]]]))
                if("character" %in% classes){
                    sample_metrics[[sele_cols[i]]] <- as.character(sample_metrics[[sele_cols[i]]])
                    variants_select[[sele_cols[i]]] <- as.character(variants_select[[sele_cols[i]]])
                }
                if("numeric" %in% classes){
                    sample_metrics[[sele_cols[i]]] <- as.numeric(sample_metrics[[sele_cols[i]]])
                    variants_select[[sele_cols[i]]] <- as.numeric(variants_select[[sele_cols[i]]])
                }
            }
        }
        combined_samples <- full_join(variants_select,sample_metrics,copy = TRUE)
    }
    else{
        combined_samples <- variants_select
    }
    if(!"sample_index" %in% colnames(AVENIO_runs_select)){
        AVENIO_runs_select <- AVENIO_runs_select %>% 
            mutate(sample_index = paste0(Project,"_",
                                         Name_in_project,"_",
                                         substr(str_split_i(as.character(Sample_date),"-",1),3,4),
                                         str_split_i(as.character(Sample_date),"-",2),
                                         str_split_i(as.character(Sample_date),"-",3))) %>% 
            dplyr::mutate(
                sample_index = ifelse(Material == "cfDNA",
                                      sample_index,
                                      ifelse(Material == "tissue",
                                             paste0(sample_index,"_",
                                                    Material,"_",
                                                    Sample_note),
                                             ifelse(Material == "reanalyze",
                                                    ifelse(Sample_note == "BC",
                                                           paste0(sample_index,"_",
                                                                  Material,"_",
                                                                  Sample_note),
                                                           paste0(sample_index,"_",
                                                                  Material)),
                                                    paste0(sample_index,"_",
                                                           Material)))))
    }
    AVENIO_runs_select_merge <- AVENIO_runs_select %>% 
        dplyr::select(Sample_name,sample_index)
    combined_samples <- combined_samples %>% 
        left_join(AVENIO_runs_select_merge,by = c("Sample.ID"="Sample_name")) %>% 
        relocate(sample_index,.before = Sample.ID) %>% 
        arrange(sample_index,Gene)
    return(list(combined_samples,
                AVENIO_runs_select))
}

sample_res_1 <- add_samples_mod(zip_path1)
combined_samples1 <- AvenioUpdate:::add_DNAfusion_res(sample_res_1[[1]],
                                                      repo_path = zip_path1,
                                                      sample_info = sample_res_1[[2]])
create_df_list_mod <- function(sample_df){
    samples <- unique(sample_df$Sample.ID)
    AVENIO_runs <- read_xlsx("//Synology_m1/Synology_folder/AVENIO/AVENIO_runs.xlsx",col_types = c(rep("guess",4),"date",rep("guess",6)))
    AVENIO_runs_select <- AVENIO_runs %>% 
        filter(Sample_name %in% samples)
    unique_patients <- unique(AVENIO_runs_select$CPR)
    df_list <- list()
    for (i in 1:length(unique_patients)){
        CPR_patient <- unique_patients[i]
        patient_df <- AVENIO_runs_select %>% 
            filter(CPR == CPR_patient)
        patient_variants <- sample_df %>% 
            filter(Sample.ID %in% patient_df$Sample_name)
        df_list[[i]] <- patient_variants 
        names(df_list)[i] <- CPR_patient
    }
    return(df_list)
}
master_list <- create_df_list_mod(combined_samples1)

dir <- paste0("//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Plasma-",added_runs[2])

master_list <- AvenioUpdate::add_run_to_list(
    master_list = master_list,
    Directory = dir,
    force_execution = TRUE)

included_analyses(master_list)

re_added_analyses <- added_runs[1:2]

for(i in 3:length(added_plasma_runs)){
    message(paste0("Adding 'Plasma' run ",i," of ",length(added_plasma_runs)))
    dir <- paste0("//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Plasma-",added_plasma_runs[i])
    master_list <- readRDS("//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds")
    master_list <- AvenioUpdate::add_run_to_list(
        master_list = master_list,
        Directory = dir,
        force_execution = TRUE)
    re_added_analyses[i] <- added_plasma_runs[i]
}
for(i in 1:length(added_tissue_runs)){
    message(paste0("Adding 'Tissue' run ",i," of ",length(added_tissue_runs)))
    dir <- paste0("//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Tissue-",added_tissue_runs[i])
    master_list <- readRDS("//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds")
    master_list <- AvenioUpdate::add_run_to_list(
        master_list = master_list,
        Directory = dir,
        force_execution = TRUE)
    re_added_analyses[length(re_added_analyses)+1] <- added_tissue_runs[i]
}
re_added_analyses == added_runs
library(AvenioUpdate)
master_list <- readRDS("//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds")
analyses <- AvenioUpdate::included_analyses(master_list)
print(analyses[[1]], n= nrow(analyses[[1]]))
AvenioUpdate::result_stats()$Basestats
AvenioUpdate::result_stats()$Missing
AvenioUpdate::explore_AVENIO_runs(Info = "Unincluded_analyses")

dir <- "//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Plasma-AajqaHzI9_hCH4wYCbDAIYx4"
master_list <- add_run_to_list(master_list = master_list,
                               Directory = dir)

create_simple_output(master_list, CPR = "2309772396")
master_list[["2309772396"]]

mon <- extract_project(master_list, project = "MonAlec")
library(dplyr)
mon %>% 
    filter(grepl("DNAfusion",Flags))
library(AvenioUpdate)
master_list <- readRDS("//Synology_m1/Synology_folder/AVENIO/AVENIO_results_patients.rds")
master_list <- AvenioUpdate::add_run_to_list(
    master_list = master_list,
    Directory <- "//Synology_m1/Synology_folder/AVENIO/AVENIO_results/Tissue-ALfftHDzDf9Evo2fz0r1muEC",
    force_execution = TRUE)

